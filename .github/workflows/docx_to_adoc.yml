name: Convert DOCX files to AsciiDoc

on:
  push:
    paths:
      - "docs/raw_LTT/*.docx"

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Convert DOCX files to AsciiDoc
        run: |
          mkdir -p docs/lecture_topic_tasks
          mkdir -p docs/img

          shopt -s nullglob
          for docx in docs/raw_LTT/*.docx; do
            base="$(basename "$docx" .docx)"
            out="docs/lecture_topic_tasks/${base}.adoc"
            media_dir="docs/img/${base}"

            mkdir -p "$media_dir"

            echo "Converting $docx -> $out (images -> $media_dir)"
            pandoc "$docx" \
              -t asciidoc \
              -o "$out" \
              --extract-media="$media_dir"
          done

      - name: Commit converted files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add docs/lecture_topic_tasks/*.adoc || true
          git add docs/img || true

          if git diff --cached --quiet; then
            echo "No converted files to commit."
          else
            git commit -m "chore: auto-convert LTT DOCX to AsciiDoc"
            git push
          fi
