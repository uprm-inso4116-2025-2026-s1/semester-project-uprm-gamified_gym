name: Convert LTT docx to adoc

on:
  push:
    paths:
      - "docs/raw_LTT/*.docx"      # triggers when you add/change docx in this folder

permissions:
  contents: write

jobs:
  docx-to-adoc:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Convert .docx lecture topic tasks to .adoc
        run: |
          mkdir -p docs/lecture_topic_tasks
          mkdir -p docs/img
          shopt -s nullglob

          for file in docs/raw_LTT/*.docx; do
            base="$(basename "$file" .docx)"

            echo "Converting $file -> docs/lecture_topic_tasks/${base}.adoc"

            # 1) Convert DOCX to AsciiDoc and extract images
            pandoc "$file" \
              --from=docx \
              --to=asciidoc \
              --extract-media="docs/img/${base}" \
              -o "docs/lecture_topic_tasks/${base}.adoc"

            adoc="docs/lecture_topic_tasks/${base}.adoc"

            # 2) Fix image macros so Asciidoctor can render them
            sed -i "s|image:docs/img/${base}/|image::img/${base}/|g" "$adoc"
            sed -i 's|image:docs/img/|image::img/|g' "$adoc"

            # Optional: clean duplicated alt text like [docs/img/.../image2,width=...]
            sed -i 's|\[docs/img/[^,]*,width=|[width=|g' "$adoc"
          done

      - name: Commit and push generated .adoc + images
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Add the whole folders so NEW files are included automatically
          git add docs/lecture_topic_tasks docs/img || true

          if git diff --cached --quiet; then
            echo "No docxâ†’adoc changes to commit."
          else
            git commit -m "chore: convert LTT .docx to .adoc and fix image paths"
            git push
          fi
